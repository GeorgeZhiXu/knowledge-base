name: Deploy Knowledge Base to Mac Mini

on:
  push:
    branches: [main]
    paths-ignore: ['**.md']
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        env:
          AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
          GH_TOKEN: ${{ github.token }}
        with:
          host: ${{ secrets.MAC_MINI_HOST }}
          username: ${{ secrets.MAC_MINI_USER }}
          key: ${{ secrets.MAC_MINI_SSH_KEY }}
          command_timeout: 10m
          envs: GH_TOKEN,AWS_BEARER_TOKEN_BEDROCK
          script: |
            set -e
            export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

            PROD_DIR="/Users/xuzhi/prod/knowledge-base"
            GATEWAY_DIR="/Users/xuzhi/prod/gateway"
            REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/GeorgeZhiXu/knowledge-base.git"

            # Clone or pull
            if [ ! -d "$PROD_DIR/.git" ]; then
              if [ -d "$PROD_DIR" ]; then
                mv "$PROD_DIR" "${PROD_DIR}.bak.$(date +%Y%m%d%H%M%S)"
              fi
              git clone "$REPO_URL" "$PROD_DIR"
            else
              cd "$PROD_DIR"
              git remote set-url origin "$REPO_URL"
              # Backup database before pull (in case git touches it)
              if [ -f data/knowledge.db ]; then
                cp data/knowledge.db data/knowledge.db.pre-deploy
              fi
              git pull origin main
              # Restore database if pull removed it
              if [ ! -f data/knowledge.db ] && [ -f data/knowledge.db.pre-deploy ]; then
                mv data/knowledge.db.pre-deploy data/knowledge.db
              else
                rm -f data/knowledge.db.pre-deploy
              fi
              git remote set-url origin "https://github.com/GeorgeZhiXu/knowledge-base.git"
            fi
            cd "$PROD_DIR"

            # Create venv and install deps
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            .venv/bin/pip install fastapi "uvicorn[standard]" sqlmodel aiosqlite pydantic greenlet anthropic python-dotenv -q

            # Ensure data directory exists
            mkdir -p data

            # Always update .env file from secrets
            echo "Updating .env file from GitHub secrets..."
            echo "DATABASE_URL=sqlite+aiosqlite:///./data/knowledge.db" > .env
            echo "AWS_BEARER_TOKEN_BEDROCK=$AWS_BEARER_TOKEN_BEDROCK" >> .env

            # Copy gateway configs
            mkdir -p "$GATEWAY_DIR/config/services.d" "$GATEWAY_DIR/pm2.d"
            cp gateway/nginx.conf "$GATEWAY_DIR/config/services.d/knowledgebase.conf"
            cp gateway/pm2.config.js "$GATEWAY_DIR/pm2.d/knowledge-base.config.js"

            # Restart service
            pm2 delete knowledge-base 2>/dev/null || true
            pm2 start "$GATEWAY_DIR/pm2.d/knowledge-base.config.js"
            pm2 save

            # Reload nginx
            nginx -t -c "$GATEWAY_DIR/config/nginx.conf"
            if ! nginx -c "$GATEWAY_DIR/config/nginx.conf" -s reload 2>/dev/null; then
              pkill nginx 2>/dev/null || true
              sleep 1
              rm -f "$GATEWAY_DIR/logs/nginx.pid"
              nginx -c "$GATEWAY_DIR/config/nginx.conf"
            fi

            sleep 5
            curl -sf http://127.0.0.1:8020/health && echo " - Knowledge Base healthy" || echo " - Health check pending (service may still be starting)"
